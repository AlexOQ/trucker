<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ETS2 Trucker Advisor</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="container">
    <header>
      <div class="header-title">
        <h1>ETS2 Trucker Advisor</h1>
        <p class="subtitle">Optimize your trailer fleet for each garage</p>
      </div>
      <nav>
        <a href="index.html" class="active">Rankings</a>
        <a href="cities.html">Cities</a>
        <a href="companies.html">Companies</a>
        <a href="cargo.html">Cargo</a>
      </nav>
    </header>

    <div class="controls">
      <div class="controls-header">
        <h2>Algorithm Settings</h2>
        <button class="reset-btn" id="reset-btn">Reset to Defaults</button>
      </div>
      <div class="controls-grid">
        <div class="control-group">
          <div class="control-label">
            <span class="tooltip" tabindex="0" data-tooltip="Left = prioritize high-paying cargo. Right = prioritize covering more cargo types. Middle = balanced.">Scoring Balance</span>
            <span class="control-value" id="scoring-value">50</span>
          </div>
          <div class="slider-container">
            <span class="slider-label">High €/km</span>
            <input type="range" id="scoring-slider" min="0" max="100" value="50">
            <span class="slider-label right">Variety</span>
          </div>
        </div>

        <div class="control-group">
          <div class="control-label">
            <span class="tooltip" tabindex="0" data-tooltip="Number of trailer slots in your garage. More slots = more trailer recommendations.">Garage Size</span>
            <span class="control-value" id="trailers-value">10</span>
          </div>
          <div class="slider-container">
            <span class="slider-label">1</span>
            <input type="range" id="trailers-slider" min="1" max="20" value="10">
            <span class="slider-label right">20</span>
          </div>
        </div>

        <div class="control-group">
          <div class="control-label">
            <span class="tooltip" tabindex="0" data-tooltip="Controls whether to recommend multiple copies of top trailers or spread across different types. More variety = more cargo types covered, but may reduce average €/km.">Trailer Variety</span>
            <span class="control-value" id="diminishing-value">50</span>
          </div>
          <div class="slider-container">
            <span class="slider-label">Same types OK</span>
            <input type="range" id="diminishing-slider" min="0" max="100" value="50">
            <span class="slider-label right">Prefer different</span>
          </div>
        </div>
      </div>
    </div>

    <div id="rankings-view">
      <div id="rankings-content">
        <div class="table-section">
          <h2>City Rankings</h2>
          <div class="skeleton-row"><div class="skeleton-cell narrow"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell narrow"></div></div>
          <div class="skeleton-row"><div class="skeleton-cell narrow"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell narrow"></div></div>
          <div class="skeleton-row"><div class="skeleton-cell narrow"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell narrow"></div></div>
          <div class="skeleton-row"><div class="skeleton-cell narrow"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell narrow"></div></div>
          <div class="skeleton-row"><div class="skeleton-cell narrow"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell narrow"></div></div>
        </div>
      </div>
    </div>

    <div id="city-view" style="display: none;">
      <span class="back-link" id="back-link">← Back to rankings</span>
      <div id="city-content"></div>
    </div>
  </div>

  <script type="module">
    import { loadAllData, buildLookups } from './js/data.js?v=2'
    import { optimizeTrailerSet, calculateCityRankings } from './js/optimizer.js?v=2'
    import { getSettings, updateSettings, resetToDefaults } from './js/storage.js?v=2'

    let data = null
    let lookups = null
    let currentCityId = null
    let cachedRankings = null

    // Get city rank from cached rankings
    function getCityRank(cityId) {
      if (!cachedRankings) return null
      const index = cachedRankings.findIndex(r => r.id === cityId)
      if (index === -1) return null
      return { rank: index + 1, total: cachedRankings.length }
    }

    // Format rank for display
    function formatRank(rank, total) {
      const isTopTier = rank <= Math.ceil(total * 0.1) // Top 10%
      const className = isTopTier ? 'rank-display top-tier' : 'rank-display'
      return `<span class="${className}"><span class="rank">#${rank}</span> of ${total}</span>`
    }

    // DOM elements
    const rankingsView = document.getElementById('rankings-view')
    const rankingsContent = document.getElementById('rankings-content')
    const cityView = document.getElementById('city-view')
    const cityContent = document.getElementById('city-content')
    const backLink = document.getElementById('back-link')

    const scoringSlider = document.getElementById('scoring-slider')
    const trailersSlider = document.getElementById('trailers-slider')
    const diminishingSlider = document.getElementById('diminishing-slider')
    const scoringValue = document.getElementById('scoring-value')
    const trailersValue = document.getElementById('trailers-value')
    const diminishingValue = document.getElementById('diminishing-value')
    const resetBtn = document.getElementById('reset-btn')

    // Get current options from sliders
    function getOptions() {
      return {
        scoringBalance: parseInt(scoringSlider.value),
        maxTrailers: parseInt(trailersSlider.value),
        diminishingFactor: parseInt(diminishingSlider.value),
      }
    }

    // Update slider display values
    function updateDisplayValues() {
      scoringValue.textContent = scoringSlider.value
      trailersValue.textContent = trailersSlider.value
      diminishingValue.textContent = diminishingSlider.value
    }

    // Load settings from localStorage
    function loadSettings() {
      const settings = getSettings()
      scoringSlider.value = settings.scoringBalance
      trailersSlider.value = settings.maxTrailers
      diminishingSlider.value = settings.diminishingFactor
      updateDisplayValues()
    }

    // Save settings to localStorage
    function saveSettings() {
      updateSettings(getOptions())
    }

    // Render city rankings table
    function renderRankings() {
      const options = getOptions()
      const rankings = calculateCityRankings(data, lookups, options)
      cachedRankings = rankings // Cache for city detail lookup

      if (rankings.length === 0) {
        cachedRankings = null
        rankingsContent.innerHTML = '<div class="empty-state">No cities with data yet.</div>'
        return
      }

      rankingsContent.innerHTML = `
        <div class="table-section">
          <h2>City Rankings (${rankings.length} cities)</h2>
          <p class="table-hint">Click any city for trailer recommendations</p>
          <table class="table-rankings">
            <thead>
              <tr>
                <th>#</th>
                <th>City</th>
                <th>Country</th>
                <th class="tooltip" data-tooltip="Company facilities in this city">Depots</th>
                <th class="tooltip" data-tooltip="Total available cargo jobs">Jobs</th>
                <th class="tooltip" data-tooltip="Sum of all cargo values (with bonuses)">Value</th>
                <th class="tooltip" data-tooltip="Average value per cargo job">€/Job</th>
                <th class="tooltip" tabindex="0" data-tooltip="Ranks cities by combining job availability and cargo value. Higher score = more profitable garage location.">Score</th>
              </tr>
            </thead>
            <tbody>
              ${rankings.map((r, i) => `
                <tr class="clickable" data-city-id="${r.id}" tabindex="0">
                  <td>${i + 1}</td>
                  <td>${r.name}</td>
                  <td class="country">${r.country}</td>
                  <td>${r.depotCount}</td>
                  <td class="amount">${r.jobs}</td>
                  <td class="value">€${r.totalValue.toLocaleString()}</td>
                  <td>€${r.avgValuePerJob.toFixed(2)}</td>
                  <td class="score">${formatRank(i + 1, rankings.length)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `

      // Add click and keyboard handlers
      rankingsContent.querySelectorAll('tr.clickable').forEach(row => {
        row.addEventListener('click', () => {
          showCity(parseInt(row.dataset.cityId))
        })
        row.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault()
            showCity(parseInt(row.dataset.cityId))
          }
        })
      })
    }

    // Render city detail view
    function renderCity(cityId) {
      const options = getOptions()
      const result = optimizeTrailerSet(cityId, data, lookups, options)
      const city = lookups.citiesById.get(cityId)

      if (!city) {
        cityContent.innerHTML = '<div class="empty-state">City not found.</div>'
        return
      }

      if (result.recommendations.length === 0) {
        cityContent.innerHTML = `
          <div class="city-header">
            <h2>${city.name}</h2>
            <span class="country">${city.country}</span>
          </div>
          <div class="empty-state">No cargo data for this city yet.</div>
        `
        return
      }

      const totalTrailers = result.recommendations.reduce((sum, r) => sum + r.count, 0)
      const trailerTypes = result.recommendations.length
      const cityRank = getCityRank(cityId)

      cityContent.innerHTML = `
        <div class="city-header">
          <h2>${city.name}</h2>
          <span class="country">${city.country}</span>
        </div>

        <div class="stats">
          <div class="stat">
            <div class="stat-value">${result.totalDepots}</div>
            <div class="stat-label">Depots</div>
          </div>
          <div class="stat">
            <div class="stat-value">${result.totalCargoInstances}</div>
            <div class="stat-label">Jobs Available</div>
          </div>
          <div class="stat">
            <div class="stat-value">€${result.totalValue.toLocaleString()}</div>
            <div class="stat-label">Total Value</div>
          </div>
          <div class="stat">
            <div class="stat-value">${totalTrailers}</div>
            <div class="stat-label">Trailers (${trailerTypes} types)</div>
          </div>
          <div class="stat">
            <div class="stat-value">${cityRank ? formatRank(cityRank.rank, cityRank.total) : '-'}</div>
            <div class="stat-label">Rank</div>
          </div>
        </div>

        <div class="table-section">
          <div class="section-header">
            <h2>Recommended Trailers</h2>
            <button class="btn copy-btn" id="copy-trailers-btn">Copy to clipboard</button>
          </div>
          <table>
            <thead>
              <tr>
                <th>Trailer</th>
                <th class="tooltip" data-tooltip="How many of this trailer to buy">Copies</th>
                <th class="tooltip" data-tooltip="% of cargo types this trailer can haul">Coverage</th>
                <th class="tooltip" data-tooltip="Average value per job for this trailer">€/Job/km</th>
                <th class="tooltip" tabindex="0" data-tooltip="Combines €/km value and job coverage based on your Scoring Balance setting. Higher = better trailer choice.">Score</th>
              </tr>
            </thead>
            <tbody>
              ${result.recommendations.map(r => `
                <tr>
                  <td>
                    <div class="trailer-name">${r.trailerName}</div>
                    <div class="trailer-cargoes">Hauls: ${r.topCargoes.join(', ')}</div>
                  </td>
                  <td class="amount">${r.count}</td>
                  <td class="coverage">${r.coveragePct}%</td>
                  <td class="value">€${r.avgValue.toFixed(2)}</td>
                  <td>${r.score.toFixed(3)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `

      // Add copy button handler
      const copyBtn = document.getElementById('copy-trailers-btn')
      copyBtn.addEventListener('click', () => {
        const trailerList = result.recommendations
          .map(r => r.count > 1 ? `${r.trailerName} ×${r.count}` : r.trailerName)
          .join(', ')
        const text = `${city.name} (${totalTrailers} trailers): ${trailerList}`

        copyToClipboard(text, copyBtn)
      })
    }

    // Copy text to clipboard with fallback
    function copyToClipboard(text, button) {
      const originalText = button.textContent

      const showSuccess = () => {
        button.textContent = 'Copied!'
        button.classList.add('copied')
        setTimeout(() => {
          button.textContent = originalText
          button.classList.remove('copied')
        }, 2000)
      }

      const showError = () => {
        button.textContent = 'Failed'
        setTimeout(() => {
          button.textContent = originalText
        }, 2000)
      }

      // Try modern clipboard API first
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
          .then(showSuccess)
          .catch(() => {
            // Fallback for non-HTTPS or permission denied
            fallbackCopy(text) ? showSuccess() : showError()
          })
      } else {
        // Fallback for older browsers
        fallbackCopy(text) ? showSuccess() : showError()
      }
    }

    // Fallback copy using execCommand
    function fallbackCopy(text) {
      const textarea = document.createElement('textarea')
      textarea.value = text
      textarea.style.position = 'fixed'
      textarea.style.opacity = '0'
      document.body.appendChild(textarea)
      textarea.select()
      try {
        const success = document.execCommand('copy')
        document.body.removeChild(textarea)
        return success
      } catch {
        document.body.removeChild(textarea)
        return false
      }
    }

    // Show city detail view
    function showCity(cityId) {
      currentCityId = cityId
      rankingsView.style.display = 'none'
      cityView.style.display = 'block'
      if (window.location.hash !== `#city-${cityId}`) {
        window.location.hash = `city-${cityId}`
      }
      renderCity(cityId)
      window.scrollTo(0, 0)
    }

    // Show rankings view
    function showRankings() {
      currentCityId = null
      cityView.style.display = 'none'
      rankingsView.style.display = 'block'
      window.location.hash = ''
      renderRankings()
    }

    // Handle hash navigation (e.g., #city-19)
    function handleHashNavigation() {
      const hash = window.location.hash
      if (hash.startsWith('#city-')) {
        const cityId = parseInt(hash.replace('#city-', ''))
        if (cityId && lookups?.citiesById.has(cityId)) {
          showCity(cityId)
          return true
        }
      }
      return false
    }

    // Handle slider changes
    function onSliderChange() {
      updateDisplayValues()
      saveSettings()
      if (currentCityId) {
        renderCity(currentCityId)
      } else {
        renderRankings()
      }
    }

    // Initialize
    async function init() {
      try {
        data = await loadAllData()
        lookups = buildLookups(data)

        loadSettings()

        // Check for hash navigation, otherwise show rankings
        if (!handleHashNavigation()) {
          renderRankings()
        }

        // Event listeners
        scoringSlider.addEventListener('input', onSliderChange)
        trailersSlider.addEventListener('input', onSliderChange)
        diminishingSlider.addEventListener('input', onSliderChange)

        backLink.addEventListener('click', showRankings)
        window.addEventListener('hashchange', () => {
          if (!handleHashNavigation()) {
            showRankings()
          }
        })

        resetBtn.addEventListener('click', () => {
          const defaults = resetToDefaults()
          scoringSlider.value = defaults.scoringBalance
          trailersSlider.value = defaults.maxTrailers
          diminishingSlider.value = defaults.diminishingFactor
          onSliderChange()
        })

      } catch (err) {
        console.error('Failed to initialize:', err)
        rankingsContent.innerHTML = `
          <div class="empty-state">
            Failed to load data. Make sure you've run <code>npm run export</code>
          </div>
        `
      }
    }

    init()
  </script>
</body>
</html>
