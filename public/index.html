<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ETS2 Trucker Advisor</title>
  <link rel="stylesheet" href="css/style.css?v=3">
</head>
<body>
  <div class="container">
    <header>
      <div class="header-title">
        <h1>ETS2 Trucker Advisor</h1>
        <p class="subtitle">Optimize your trailer fleet for each garage</p>
      </div>
      <nav>
        <a href="index.html" class="active">Rankings</a>
        <a href="cities.html">Cities</a>
        <a href="companies.html">Companies</a>
        <a href="cargo.html">Cargo</a>
      </nav>
    </header>

    <div class="onboarding">
      <h2>Getting Started</h2>
      <p class="onboarding-intro">
        This tool helps you choose the most profitable garage locations and the best trailers to buy for each one.
        It analyzes all cargo jobs available in each city and recommends which trailers will maximize your income.
      </p>
      <div class="quick-steps">
        <div class="step">
          <span class="step-number">1</span>
          <div class="step-content">
            <strong>Browse city rankings</strong>
            <span>Cities are ranked by job availability and cargo value</span>
          </div>
        </div>
        <div class="step">
          <span class="step-number">2</span>
          <div class="step-content">
            <strong>Click a city for trailer recommendations</strong>
            <span>See which trailers work best for that location</span>
          </div>
        </div>
        <div class="step">
          <span class="step-number">3</span>
          <div class="step-content">
            <strong>Mark your garages with ★</strong>
            <span>Track which cities you've set up garages in</span>
          </div>
        </div>
      </div>
      <div class="terminology">
        <h3>Key Terms</h3>
        <dl class="term-list">
          <dt class="tooltip" tabindex="0" data-tooltip="Company facilities (like Posped, EuroGoodies, etc.) that offer cargo jobs in a city">Depots</dt>
          <dd>Company facilities where you pick up cargo</dd>

          <dt class="tooltip" tabindex="0" data-tooltip="Total number of different cargo delivery opportunities available in a city">Jobs</dt>
          <dd>Available cargo delivery opportunities</dd>

          <dt class="tooltip" tabindex="0" data-tooltip="The percentage of different cargo types in a city that a trailer can haul">Coverage</dt>
          <dd>How many different cargo types a trailer can haul</dd>

          <dt class="tooltip" tabindex="0" data-tooltip="Combines job availability and cargo value to rank cities. Higher score = more profitable garage location">Score</dt>
          <dd>Overall profitability rating for a city or trailer</dd>
        </dl>
      </div>
    </div>

    <div class="controls collapsed">
      <div class="controls-header">
        <button class="settings-toggle" id="settings-toggle" aria-expanded="false">
          <span class="toggle-icon">▶</span>
          <h2>Advanced Settings</h2>
        </button>
        <button class="reset-btn" id="reset-btn">Reset to Defaults</button>
      </div>
      <div class="controls-grid" id="controls-grid">
        <div class="control-group">
          <div class="control-label">
            <span class="tooltip" tabindex="0" data-tooltip="Left = prioritize high-paying cargo. Right = prioritize covering more cargo types.">Scoring Balance</span>
            <span class="control-value" id="scoring-value">50</span>
          </div>
          <p class="slider-description">Choose between high-value jobs or covering more cargo types</p>
          <div class="slider-container">
            <span class="slider-label">High €/km</span>
            <input type="range" id="scoring-slider" min="0" max="100" value="50">
            <span class="slider-label right">Variety</span>
          </div>
        </div>

        <div class="control-group">
          <div class="control-label">
            <span class="tooltip" tabindex="0" data-tooltip="Number of trailer slots in your garage (1-20)">Garage Size</span>
            <span class="control-value" id="trailers-value">10</span>
          </div>
          <p class="slider-description">Set how many trailer parking spots you have</p>
          <div class="slider-container">
            <span class="slider-label">1</span>
            <input type="range" id="trailers-slider" min="1" max="20" value="10">
            <span class="slider-label right">20</span>
          </div>
        </div>

        <div class="control-group">
          <div class="control-label">
            <span class="tooltip" tabindex="0" data-tooltip="Left = allow duplicate trailers if profitable. Right = force different trailer types.">Trailer Variety</span>
            <span class="control-value" id="diminishing-value">50</span>
          </div>
          <p class="slider-description">Balance between buying duplicate trailers vs. different types</p>
          <div class="slider-container">
            <span class="slider-label">Same types OK</span>
            <input type="range" id="diminishing-slider" min="0" max="100" value="50">
            <span class="slider-label right">Prefer different</span>
          </div>
        </div>
      </div>
    </div>

    <div class="search-box">
      <input type="text" id="city-search" placeholder="Search cities...">
    </div>

    <div class="country-filter">
      <button
        class="country-filter-btn"
        id="country-filter-btn"
        aria-expanded="false"
        aria-label="Filter by country"
        aria-haspopup="listbox">
        All Countries
      </button>
      <div
        class="country-dropdown"
        id="country-dropdown"
        role="listbox"
        aria-multiselectable="true"
        aria-label="Country selection"
        style="display: none;">
        <div class="country-options" id="country-options">
          <!-- Populated dynamically -->
        </div>
      </div>
    </div>

    <div class="filter-toggle" id="filter-toggle">
      <button class="filter-btn active" data-filter="all">All Cities</button>
      <button class="filter-btn" data-filter="owned">My Garages <span class="badge" id="garage-count">0</span></button>
    </div>

    <div id="rankings-view">
      <div id="rankings-content">
        <div class="table-section">
          <h2>City Rankings</h2>
          <div class="skeleton-row"><div class="skeleton-cell narrow"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell narrow"></div></div>
          <div class="skeleton-row"><div class="skeleton-cell narrow"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell narrow"></div></div>
          <div class="skeleton-row"><div class="skeleton-cell narrow"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell narrow"></div></div>
          <div class="skeleton-row"><div class="skeleton-cell narrow"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell narrow"></div></div>
          <div class="skeleton-row"><div class="skeleton-cell narrow"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell medium"></div><div class="skeleton-cell narrow"></div><div class="skeleton-cell narrow"></div></div>
        </div>
      </div>
    </div>

    <div id="city-view" style="display: none;">
      <span class="back-link" id="back-link">← Back to rankings</span>
      <div id="city-content"></div>
    </div>
  </div>

  <script type="module">
    import { loadAllData, buildLookups } from './js/data.js?v=2'
    import { optimizeTrailerSet, calculateCityRankings } from './js/optimizer.js?v=2'
    import { getSettings, updateSettings, resetToDefaults, getOwnedGarages, isOwnedGarage, toggleOwnedGarage, getFilterMode, setFilterMode, getSelectedCountries, setSelectedCountries } from './js/storage.js?v=2'

    let data = null
    let lookups = null
    let currentCityId = null
    let cachedRankings = null

    // Extract unique countries from data, sorted alphabetically
    function getUniqueCountries() {
      if (!data || !data.cities) return []
      const countries = [...new Set(data.cities.map(c => c.country))]
      return countries.sort()
    }

    // Toggle dropdown visibility
    function toggleDropdown() {
      const dropdown = document.getElementById('country-dropdown')
      const btn = document.getElementById('country-filter-btn')
      const isVisible = dropdown.style.display !== 'none'

      if (isVisible) {
        dropdown.style.display = 'none'
        btn.setAttribute('aria-expanded', 'false')
      } else {
        dropdown.style.display = 'block'
        btn.setAttribute('aria-expanded', 'true')
        // Focus first checkbox when opening
        const firstCheckbox = dropdown.querySelector('input[type="checkbox"]')
        if (firstCheckbox) {
          firstCheckbox.focus()
        }
      }
    }

    // Close dropdown
    function closeDropdown() {
      const dropdown = document.getElementById('country-dropdown')
      const btn = document.getElementById('country-filter-btn')
      dropdown.style.display = 'none'
      btn.setAttribute('aria-expanded', 'false')
    }

    // Update button text based on selection
    function updateCountryButtonText() {
      const selected = getSelectedCountries()
      const btn = document.getElementById('country-filter-btn')

      if (selected.length === 0) {
        btn.textContent = 'All Countries'
        btn.setAttribute('aria-label', 'Filter by country')
      } else if (selected.length === 1) {
        btn.textContent = '1 Country'
        btn.setAttribute('aria-label', 'Filter by country, 1 selected')
      } else {
        btn.textContent = `${selected.length} Countries`
        btn.setAttribute('aria-label', `Filter by country, ${selected.length} selected`)
      }
    }

    // Render country checkboxes in dropdown
    function renderCountryCheckboxes() {
      const countries = getUniqueCountries()
      const countryOptions = document.getElementById('country-options')
      const selected = getSelectedCountries()

      countryOptions.innerHTML = `
        <label class="country-option all-countries" role="option">
          <input
            type="checkbox"
            id="all-countries-checkbox"
            aria-checked="${selected.length === 0 ? 'true' : 'false'}"
            ${selected.length === 0 ? 'checked' : ''}>
          <span>All Countries</span>
        </label>
        ${countries.map(country => `
          <label class="country-option" role="option">
            <input
              type="checkbox"
              value="${country}"
              aria-checked="${selected.includes(country) ? 'true' : 'false'}"
              aria-label="${country}"
              ${selected.includes(country) ? 'checked' : ''}>
            <span>${country}</span>
          </label>
        `).join('')}
      `

      // Add handler for "All Countries" checkbox
      const allCountriesCheckbox = document.getElementById('all-countries-checkbox')
      allCountriesCheckbox.addEventListener('change', (e) => {
        if (e.target.checked) {
          e.target.setAttribute('aria-checked', 'true')
          setSelectedCountries([])
          renderCountryCheckboxes()
          updateCountryButtonText()
          renderRankings()
        }
      })

      // Add change handlers to country checkboxes
      countryOptions.querySelectorAll('input[type="checkbox"]:not(#all-countries-checkbox)').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
          const country = e.target.value
          const selected = getSelectedCountries()

          if (e.target.checked) {
            e.target.setAttribute('aria-checked', 'true')
            if (!selected.includes(country)) {
              setSelectedCountries([...selected, country])
            }
          } else {
            e.target.setAttribute('aria-checked', 'false')
            setSelectedCountries(selected.filter(c => c !== country))
          }

          // Re-render checkboxes to update "All Countries" state
          renderCountryCheckboxes()
          // Update button text to show count
          updateCountryButtonText()
          // Re-render rankings with new filter
          renderRankings()
        })
      })
    }

    // Get city rank from cached rankings
    function getCityRank(cityId) {
      if (!cachedRankings) return null
      const index = cachedRankings.findIndex(r => r.id === cityId)
      if (index === -1) return null
      return { rank: index + 1, total: cachedRankings.length }
    }

    // Format rank for display (optional score for tooltip)
    function formatRank(rank, total, score = null) {
      const isTopTier = rank <= Math.ceil(total * 0.1) // Top 10%
      const baseClass = isTopTier ? 'rank-display top-tier' : 'rank-display'
      const className = score !== null ? `${baseClass} tooltip` : baseClass
      const tooltipAttrs = score !== null ? ` tabindex="0" data-tooltip="Score: ${score.toFixed(0)}"` : ''
      return `<span class="${className}"${tooltipAttrs}><span class="rank">#${rank}</span> of ${total}</span>`
    }

    // Update garage count badge
    function updateGarageCount() {
      const count = getOwnedGarages().length
      document.getElementById('garage-count').textContent = count
    }

    // DOM elements
    const rankingsView = document.getElementById('rankings-view')
    const rankingsContent = document.getElementById('rankings-content')
    const cityView = document.getElementById('city-view')
    const cityContent = document.getElementById('city-content')
    const backLink = document.getElementById('back-link')

    const scoringSlider = document.getElementById('scoring-slider')
    const trailersSlider = document.getElementById('trailers-slider')
    const diminishingSlider = document.getElementById('diminishing-slider')
    const scoringValue = document.getElementById('scoring-value')
    const trailersValue = document.getElementById('trailers-value')
    const diminishingValue = document.getElementById('diminishing-value')
    const resetBtn = document.getElementById('reset-btn')
    const filterToggle = document.getElementById('filter-toggle')
    const citySearch = document.getElementById('city-search')
    const settingsToggle = document.getElementById('settings-toggle')
    const controlsGrid = document.getElementById('controls-grid')

    // Normalize text for accent-insensitive search
    function normalize(str) {
      return str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '')
    }

    // Filter toggle click handler
    filterToggle.addEventListener('click', (e) => {
      const btn = e.target.closest('.filter-btn')
      if (!btn) return

      const mode = btn.dataset.filter
      filterToggle.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'))
      btn.classList.add('active')
      setFilterMode(mode)
      renderRankings()
    })

    // Get current options from sliders
    function getOptions() {
      return {
        scoringBalance: parseInt(scoringSlider.value),
        maxTrailers: parseInt(trailersSlider.value),
        diminishingFactor: parseInt(diminishingSlider.value),
      }
    }

    // Update slider display values
    function updateDisplayValues() {
      scoringValue.textContent = scoringSlider.value
      trailersValue.textContent = trailersSlider.value
      diminishingValue.textContent = diminishingSlider.value
    }

    // Load settings from localStorage
    function loadSettings() {
      const settings = getSettings()
      scoringSlider.value = settings.scoringBalance
      trailersSlider.value = settings.maxTrailers
      diminishingSlider.value = settings.diminishingFactor
      updateDisplayValues()
    }

    // Save settings to localStorage
    function saveSettings() {
      updateSettings(getOptions())
    }

    // Render city rankings table
    function renderRankings() {
      const options = getOptions()
      const rankings = calculateCityRankings(data, lookups, options)
      cachedRankings = rankings // Cache for city detail lookup

      if (rankings.length === 0) {
        cachedRankings = null
        rankingsContent.innerHTML = '<div class="empty-state">No cities with data yet.</div>'
        return
      }

      // Filter by search term
      const searchTerm = normalize(citySearch.value)
      let filtered = rankings.filter(r =>
        normalize(r.name).includes(searchTerm) ||
        normalize(r.country).includes(searchTerm)
      )

      // Filter by selected countries
      const selectedCountries = getSelectedCountries()
      if (selectedCountries.length > 0) {
        filtered = filtered.filter(r => selectedCountries.includes(r.country))
      }

      // Get filter mode and owned garages
      const filterMode = getFilterMode()
      const ownedSet = new Set(getOwnedGarages())

      // Filter by owned garages if mode is 'owned'
      const displayRankings = filterMode === 'owned'
        ? filtered.filter(r => ownedSet.has(r.id))
        : filtered

      // Handle empty state when filtered but no garages
      if (filterMode === 'owned' && displayRankings.length === 0) {
        rankingsContent.innerHTML = `
          <div class="empty-garages">
            <p>No garages marked yet.</p>
            <p class="hint">Click any city row, then click the star to mark it as your garage.</p>
          </div>
        `
        return
      }

      rankingsContent.innerHTML = `
        <div class="table-section">
          <h2>City Rankings (${displayRankings.length} cities)</h2>
          <p class="table-hint">Click any city for trailer recommendations</p>
          <table class="table-rankings">
            <thead>
              <tr>
                <th>#</th>
                <th>City</th>
                <th>Country</th>
                <th class="tooltip" data-tooltip="Company facilities in this city">Depots</th>
                <th class="tooltip" data-tooltip="Total available cargo jobs">Jobs</th>
                <th class="tooltip" data-tooltip="Sum of all cargo values (with bonuses)">Value</th>
                <th class="tooltip" data-tooltip="Average value per cargo job">€/Job</th>
                <th class="tooltip" tabindex="0" data-tooltip="Ranks cities by combining job availability and cargo value. Higher score = more profitable garage location.">Score</th>
              </tr>
            </thead>
            <tbody>
              ${displayRankings.map((r, i) => `
                <tr class="clickable${ownedSet.has(r.id) ? ' owned-garage' : ''}" data-city-id="${r.id}" tabindex="0">
                  <td>${i + 1}</td>
                  <td>${r.name}</td>
                  <td class="country">${r.country}</td>
                  <td>${r.depotCount}</td>
                  <td class="amount">${r.jobs}</td>
                  <td class="value">€${r.totalValue.toLocaleString()}</td>
                  <td>€${r.avgValuePerJob.toFixed(2)}</td>
                  <td class="score">${formatRank(i + 1, displayRankings.length, r.score)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `

      // Add click and keyboard handlers
      rankingsContent.querySelectorAll('tr.clickable').forEach(row => {
        row.addEventListener('click', () => {
          showCity(parseInt(row.dataset.cityId))
        })
        row.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault()
            showCity(parseInt(row.dataset.cityId))
          }
        })
      })
    }

    // Render city detail view
    function renderCity(cityId) {
      const options = getOptions()
      const result = optimizeTrailerSet(cityId, data, lookups, options)
      const city = lookups.citiesById.get(cityId)
      const isOwned = isOwnedGarage(cityId)

      if (!city) {
        cityContent.innerHTML = '<div class="empty-state">City not found.</div>'
        return
      }

      if (result.recommendations.length === 0) {
        cityContent.innerHTML = `
          <div class="city-header">
            <h2>${city.name}</h2>
            <button class="garage-toggle" aria-label="Toggle garage" aria-pressed="${isOwned}">
              <span class="star">${isOwned ? '★' : '☆'}</span>
            </button>
            <span class="country">${city.country}</span>
          </div>
          <div class="empty-state">No cargo data for this city yet.</div>
        `
        addGarageToggleHandler(cityId)
        return
      }

      const totalTrailers = result.recommendations.reduce((sum, r) => sum + r.count, 0)
      const trailerTypes = result.recommendations.length
      const cityRank = getCityRank(cityId)

      cityContent.innerHTML = `
        <div class="city-header">
          <h2>${city.name}</h2>
          <button class="garage-toggle" aria-label="Toggle garage" aria-pressed="${isOwned}">
            <span class="star">${isOwned ? '★' : '☆'}</span>
          </button>
          <span class="country">${city.country}</span>
        </div>

        <div class="stats">
          <div class="stat">
            <div class="stat-value">${result.totalDepots}</div>
            <div class="stat-label">Depots</div>
          </div>
          <div class="stat">
            <div class="stat-value">${result.totalCargoInstances}</div>
            <div class="stat-label">Jobs Available</div>
          </div>
          <div class="stat">
            <div class="stat-value">€${result.totalValue.toLocaleString()}</div>
            <div class="stat-label">Total Value</div>
          </div>
          <div class="stat">
            <div class="stat-value">${totalTrailers}</div>
            <div class="stat-label">Trailers (${trailerTypes} types)</div>
          </div>
          <div class="stat">
            <div class="stat-value">${cityRank ? formatRank(cityRank.rank, cityRank.total) : '-'}</div>
            <div class="stat-label">Rank</div>
          </div>
        </div>

        <div class="table-section">
          <div class="section-header">
            <h2>Recommended Trailers</h2>
            <button class="btn copy-btn" id="copy-trailers-btn">Copy to clipboard</button>
          </div>
          <table>
            <thead>
              <tr>
                <th>Trailer</th>
                <th class="tooltip" data-tooltip="How many of this trailer to buy">Copies</th>
                <th class="tooltip" tabindex="0" data-tooltip="This trailer can haul this percentage of the different cargo types available at depots in this city">Coverage</th>
                <th class="tooltip" data-tooltip="Average value per job for this trailer">€/Job/km</th>
                <th class="tooltip" tabindex="0" data-tooltip="Combines €/km value and job coverage based on your Scoring Balance setting. Higher = better trailer choice.">Score</th>
              </tr>
            </thead>
            <tbody>
              ${result.recommendations.map(r => `
                <tr>
                  <td>
                    <div class="trailer-name">${r.trailerName}</div>
                    <div class="trailer-cargoes">Hauls: ${r.topCargoes.join(', ')}</div>
                  </td>
                  <td class="amount">${r.count}</td>
                  <td class="coverage">${r.coveragePct}%</td>
                  <td class="value">€${r.avgValue.toFixed(2)}</td>
                  <td>${r.score.toFixed(3)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `

      // Add copy button handler
      const copyBtn = document.getElementById('copy-trailers-btn')
      copyBtn.addEventListener('click', () => {
        const trailerList = result.recommendations
          .map(r => r.count > 1 ? `${r.trailerName} ×${r.count}` : r.trailerName)
          .join(', ')
        const text = `${city.name} (${totalTrailers} trailers): ${trailerList}`

        copyToClipboard(text, copyBtn)
      })

      // Add garage toggle handler
      addGarageToggleHandler(cityId)
    }

    // Add garage toggle click and keyboard handler
    function addGarageToggleHandler(cityId) {
      const toggleBtn = cityContent.querySelector('.garage-toggle')
      if (toggleBtn) {
        const toggleGarage = () => {
          const newState = toggleOwnedGarage(cityId)
          toggleBtn.setAttribute('aria-pressed', newState)
          toggleBtn.querySelector('.star').textContent = newState ? '★' : '☆'
          updateGarageCount()
        }
        toggleBtn.addEventListener('click', toggleGarage)
        toggleBtn.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault()
            toggleGarage()
          }
        })
      }
    }

    // Copy text to clipboard with fallback
    function copyToClipboard(text, button) {
      const originalText = button.textContent

      const showSuccess = () => {
        button.textContent = 'Copied!'
        button.classList.add('copied')
        setTimeout(() => {
          button.textContent = originalText
          button.classList.remove('copied')
        }, 2000)
      }

      const showError = () => {
        button.textContent = 'Failed'
        setTimeout(() => {
          button.textContent = originalText
        }, 2000)
      }

      // Try modern clipboard API first
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
          .then(showSuccess)
          .catch(() => {
            // Fallback for non-HTTPS or permission denied
            fallbackCopy(text) ? showSuccess() : showError()
          })
      } else {
        // Fallback for older browsers
        fallbackCopy(text) ? showSuccess() : showError()
      }
    }

    // Fallback copy using execCommand
    function fallbackCopy(text) {
      const textarea = document.createElement('textarea')
      textarea.value = text
      textarea.style.position = 'fixed'
      textarea.style.opacity = '0'
      document.body.appendChild(textarea)
      textarea.select()
      try {
        const success = document.execCommand('copy')
        document.body.removeChild(textarea)
        return success
      } catch {
        document.body.removeChild(textarea)
        return false
      }
    }

    // Show city detail view
    function showCity(cityId) {
      currentCityId = cityId
      rankingsView.style.display = 'none'
      cityView.style.display = 'block'
      if (window.location.hash !== `#city-${cityId}`) {
        window.location.hash = `city-${cityId}`
      }
      renderCity(cityId)
      window.scrollTo(0, 0)
    }

    // Show rankings view
    function showRankings() {
      currentCityId = null
      cityView.style.display = 'none'
      rankingsView.style.display = 'block'
      window.location.hash = ''
      renderRankings()
    }

    // Handle hash navigation (e.g., #city-19)
    function handleHashNavigation() {
      const hash = window.location.hash
      if (hash.startsWith('#city-')) {
        const cityId = parseInt(hash.replace('#city-', ''))
        if (cityId && lookups?.citiesById.has(cityId)) {
          showCity(cityId)
          return true
        }
      }
      return false
    }

    // Handle slider changes
    function onSliderChange() {
      updateDisplayValues()
      saveSettings()
      if (currentCityId) {
        renderCity(currentCityId)
      } else {
        renderRankings()
      }
    }

    // Initialize
    async function init() {
      try {
        data = await loadAllData()
        lookups = buildLookups(data)

        loadSettings()
        renderCountryCheckboxes()
        updateCountryButtonText()

        // Initialize filter toggle from storage
        const savedFilterMode = getFilterMode()
        filterToggle.querySelectorAll('.filter-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.filter === savedFilterMode)
        })
        updateGarageCount()

        // Check for hash navigation, otherwise show rankings
        if (!handleHashNavigation()) {
          renderRankings()
        }

        // Event listeners
        scoringSlider.addEventListener('input', onSliderChange)
        trailersSlider.addEventListener('input', onSliderChange)
        diminishingSlider.addEventListener('input', onSliderChange)
        citySearch.addEventListener('input', renderRankings)

        backLink.addEventListener('click', showRankings)
        window.addEventListener('hashchange', () => {
          if (!handleHashNavigation()) {
            showRankings()
          }
        })

        resetBtn.addEventListener('click', () => {
          const defaults = resetToDefaults()
          scoringSlider.value = defaults.scoringBalance
          trailersSlider.value = defaults.maxTrailers
          diminishingSlider.value = defaults.diminishingFactor
          onSliderChange()
        })

        // Settings toggle handler
        settingsToggle.addEventListener('click', () => {
          const controls = settingsToggle.closest('.controls')
          const isCollapsed = controls.classList.contains('collapsed')

          if (isCollapsed) {
            controls.classList.remove('collapsed')
            settingsToggle.setAttribute('aria-expanded', 'true')
            settingsToggle.querySelector('.toggle-icon').textContent = '▼'
          } else {
            controls.classList.add('collapsed')
            settingsToggle.setAttribute('aria-expanded', 'false')
            settingsToggle.querySelector('.toggle-icon').textContent = '▶'
          }
        })

        // Country filter dropdown toggle
        const countryFilterBtn = document.getElementById('country-filter-btn')
        countryFilterBtn.addEventListener('click', (e) => {
          e.stopPropagation()
          toggleDropdown()
        })

        // Keyboard handler for dropdown button
        countryFilterBtn.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault()
            toggleDropdown()
          }
        })

        // Keyboard navigation for dropdown
        document.addEventListener('keydown', (e) => {
          const dropdown = document.getElementById('country-dropdown')
          if (dropdown.style.display === 'none') return

          if (e.key === 'Escape') {
            e.preventDefault()
            closeDropdown()
            countryFilterBtn.focus()
          } else if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
            e.preventDefault()
            const checkboxes = Array.from(dropdown.querySelectorAll('input[type="checkbox"]'))
            const currentIndex = checkboxes.findIndex(cb => cb === document.activeElement || cb.parentElement === document.activeElement)

            let nextIndex
            if (e.key === 'ArrowDown') {
              nextIndex = currentIndex < checkboxes.length - 1 ? currentIndex + 1 : 0
            } else {
              nextIndex = currentIndex > 0 ? currentIndex - 1 : checkboxes.length - 1
            }

            checkboxes[nextIndex].focus()
          } else if (e.key === ' ' && document.activeElement.type === 'checkbox') {
            // Space handled by checkbox default behavior
            e.preventDefault()
            document.activeElement.click()
          }
        })

        // Close dropdown on outside click
        document.addEventListener('click', (e) => {
          const dropdown = document.getElementById('country-dropdown')
          const filterContainer = document.querySelector('.country-filter')
          if (!filterContainer.contains(e.target) && dropdown.style.display !== 'none') {
            closeDropdown()
          }
        })

      } catch (err) {
        console.error('Failed to initialize:', err)
        rankingsContent.innerHTML = `
          <div class="empty-state">
            Failed to load data. Make sure you've run <code>npm run export</code>
          </div>
        `
      }
    }

    init()
  </script>
</body>
</html>
